<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>BadgerWiFi-Tools — Download</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <style>
    :root {
      color-scheme: light dark;
      font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      --bg: #edf1f5;
      --card-bg: rgba(255, 255, 255, 0.9);
      --card-border: hsla(215, 25%, 65%, 0.45);
      --text: #0f172a;
      --muted: #4b5563;
      --divider: hsla(215, 25%, 65%, 0.45);
      --btn-start: #2563eb;
      --btn-end: #1d4ed8;
      --btn-border: rgba(255, 255, 255, 0.35);
      --menu-bg: rgba(255, 255, 255, 0.98);
      --menu-hover: rgba(37, 99, 235, 0.12);
      --shadow: 0 16px 36px rgba(15, 23, 42, 0.16);
      --changelog-bg: rgba(255, 255, 255, 0.55);
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #050b18;
        --card-bg: rgba(15, 23, 42, 0.92);
        --card-border: hsla(220, 45%, 28%, 0.58);
        --text: #e2e8f0;
        --muted: #94a3b8;
        --divider: hsla(220, 45%, 28%, 0.42);
        --btn-start: #3b82f6;
        --btn-end: #2563eb;
        --btn-border: rgba(148, 163, 184, 0.42);
        --menu-bg: rgba(15, 23, 42, 0.96);
        --menu-hover: hsla(220, 90%, 70%, 0.18);
        --shadow: 0 20px 48px rgba(2, 6, 23, 0.55);
        --changelog-bg: rgba(15, 23, 42, 0.74);
      }
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100svh;
      display: grid;
      place-items: center;
      padding: 24px;
      background: var(--bg);
      color: var(--text);
      transition: background 0.3s ease;
    }

    a {
      color: inherit;
    }

    main.card {
      width: min(720px, 100%);
      border-radius: 20px;
      border: 1px solid var(--card-border);
      background: var(--card-bg);
      padding: 32px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      display: grid;
      gap: 24px;
    }

    h1 {
      margin: 0;
      font-size: 1.55rem;
      font-weight: 700;
    }

    .muted {
      margin: 0;
      color: var(--muted);
    }

    .btn {
      appearance: none;
      border: 1px solid transparent;
      padding: 12px 20px;
      border-radius: 12px;
      font-family: inherit;
      font-size: 1rem;
      font-weight: 600;
      letter-spacing: -0.01em;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: filter 0.2s ease, background 0.2s ease, transform 0.2s ease;
    }

    .split-control {
      position: relative;
      display: inline-flex;
      align-items: stretch;
      border-radius: 12px;
      filter: drop-shadow(0 12px 28px rgba(37, 99, 235, 0.18));
    }

    .split-control .btn {
      border-radius: 0;
      border: none;
    }

    #primaryDownload {
      border-radius: 12px 0 0 12px;
      min-width: 240px;
      background: linear-gradient(135deg, var(--btn-start), var(--btn-end));
      color: #fff;
    }

    #primaryDownload:hover {
      filter: brightness(1.06);
    }

    #primaryDownload:focus-visible {
      outline: 2px solid rgba(59, 130, 246, 0.5);
      outline-offset: 2px;
    }

    .split-control .split-toggle {
      width: 3rem;
      display: grid;
      place-items: center;
      background: linear-gradient(135deg, var(--btn-end), var(--btn-start));
      border-left: 1px solid var(--btn-border);
      border-radius: 0 12px 12px 0;
      color: #fff;
      cursor: pointer;
      font-size: 1.1rem;
    }

    .split-control .split-toggle:hover {
      filter: brightness(1.06);
    }

    .split-control .split-toggle:focus-visible {
      outline: 2px solid rgba(59, 130, 246, 0.6);
      outline-offset: 3px;
    }

    .dropdown-menu {
      position: absolute;
      top: calc(100% + 0.5rem);
      left: 0;
      min-width: 240px;
      background: var(--menu-bg);
      border: 1px solid var(--divider);
      border-radius: 12px;
      box-shadow: var(--shadow);
      padding: 0.35rem 0;
      z-index: 30;
      backdrop-filter: blur(16px);
    }

    .dropdown-menu a {
      display: block;
      padding: 0.65rem 1rem;
      color: var(--text);
      text-decoration: none;
      font-weight: 500;
    }

    .dropdown-menu a:hover {
      background: var(--menu-hover);
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      border: 0;
    }

    .supporting {
      display: grid;
      gap: 6px;
    }

    .changelog {
      border: 1px dashed var(--divider);
      border-radius: 16px;
      padding: 16px 20px;
      background: var(--changelog-bg);
      display: grid;
      gap: 10px;
    }

    .changelog h2 {
      margin: 0;
      font-size: 1rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .changelog ul {
      margin: 0;
      padding-left: 20px;
      display: grid;
      gap: 6px;
    }

    .changelog li {
      line-height: 1.4;
    }

    .history-link {
      text-decoration: none;
      font-size: 0.95rem;
      font-weight: 500;
      display: inline-flex;
      gap: 6px;
      align-items: center;
      color: inherit;
    }

    .history-link span {
      font-size: 1.1rem;
    }
  </style>
</head>
<body>
  <main class="card">
    <div class="supporting">
      <h1>BadgerWiFi-Tools</h1>
      <p class="muted">Current release: <span id="versionTag">–</span></p>
      <p class="muted" id="releaseMeta"></p>
    </div>

    <div class="split-control" id="downloadControls">
      <a id="primaryDownload" class="btn btn-primary" href="#" download>
        Download Latest Version
      </a>
      <button id="downloadMenuToggle" class="btn split-toggle" type="button" aria-haspopup="menu" aria-expanded="false" hidden>
        <span aria-hidden="true">▾</span>
        <span class="sr-only">Show other installers</span>
      </button>
      <div id="downloadMenu" class="dropdown-menu" role="menu" hidden></div>
    </div>

    <section class="changelog" aria-live="polite">
      <h2>Latest release</h2>
      <ul id="latest-changelog">
        <li>Loading…</li>
      </ul>
    </section>

    <a class="history-link" href="history.html">
      <span aria-hidden="true">↗</span>
      View full release history
    </a>
  </main>

  <script>
const detectPlatform = () => {
  const ua = navigator.userAgent || '';
  const lower = ua.toLowerCase();
  if (lower.includes('mac os x') || lower.includes('macintosh')) return 'mac';
  if (lower.includes('windows')) return 'windows';
  return 'unknown';
};

const isSafeDownload = url => {
  try {
    const parsed = new URL(url, location.origin);
    return parsed.protocol === 'https:' || parsed.protocol === 'http:';
  } catch {
    return false;
  }
};

const normaliseDownload = (entry, fallbackLabel) => {
  if (!entry) return null;
  if (typeof entry === 'string') {
    return { url: entry, label: fallbackLabel };
  }
  if (entry.url) {
    return { url: entry.url, label: entry.label || fallbackLabel };
  }
  return null;
};

const applyButton = (button, download, defaultLabel) => {
  if (!download || !isSafeDownload(download.url)) {
    button.href = '#';
    button.removeAttribute('download');
    button.textContent = defaultLabel;
    return;
  }

  button.href = download.url;
  button.setAttribute('download', '');
  const text = download.label || defaultLabel;
  button.textContent = text;
};

const collectAlternates = (primary, candidates) => {
  const options = [];
  const seen = new Set();
  const primaryUrl = primary && primary.url;
  candidates.forEach(candidate => {
    if (!candidate || !candidate.url) return;
    if (candidate.url === primaryUrl) return;
    if (seen.has(candidate.url)) return;
    seen.add(candidate.url);
    options.push(candidate);
  });
  return options;
};

const primaryButton = document.getElementById('primaryDownload');
const menuToggle = document.getElementById('downloadMenuToggle');
const menu = document.getElementById('downloadMenu');
const downloadControls = document.getElementById('downloadControls');
const latestList = document.getElementById('latest-changelog');
const versionTag = document.getElementById('versionTag');
const releaseMeta = document.getElementById('releaseMeta');

const defaultRadius = '12px';
primaryButton.style.borderTopRightRadius = defaultRadius;
primaryButton.style.borderBottomRightRadius = defaultRadius;
menuToggle.style.borderTopRightRadius = defaultRadius;
menuToggle.style.borderBottomRightRadius = defaultRadius;

const closeMenu = () => {
  if (menu.hidden) return;
  menu.hidden = true;
  menuToggle.setAttribute('aria-expanded', 'false');
};

const renderMenu = items => {
  menu.innerHTML = '';

  if (!items.length) {
    closeMenu();
    menuToggle.hidden = true;
    menuToggle.setAttribute('aria-expanded', 'false');
    primaryButton.style.borderTopRightRadius = defaultRadius;
    primaryButton.style.borderBottomRightRadius = defaultRadius;
    menuToggle.style.borderTopRightRadius = defaultRadius;
    menuToggle.style.borderBottomRightRadius = defaultRadius;
    return;
  }

  items.forEach(item => {
    const link = document.createElement('a');
    link.href = item.url;
    link.setAttribute('download', '');
    link.setAttribute('role', 'menuitem');
    link.textContent = item.label;
    link.addEventListener('click', () => closeMenu());
    menu.appendChild(link);
  });

  menu.hidden = true;
  menuToggle.hidden = false;
  menuToggle.setAttribute('aria-expanded', 'false');
  primaryButton.style.borderTopRightRadius = '0';
  primaryButton.style.borderBottomRightRadius = '0';
  menuToggle.style.borderTopRightRadius = defaultRadius;
  menuToggle.style.borderBottomRightRadius = defaultRadius;
};

menuToggle.addEventListener('click', event => {
  event.stopPropagation();
  if (menu.hidden) {
    menu.hidden = false;
    menuToggle.setAttribute('aria-expanded', 'true');
  } else {
    closeMenu();
  }
});

document.addEventListener('click', event => {
  if (menuToggle.hidden) return;
  if (!downloadControls.contains(event.target)) {
    closeMenu();
  }
});

document.addEventListener('keydown', event => {
  if (event.key === 'Escape') {
    closeMenu();
  }
});

primaryButton.addEventListener('click', () => closeMenu());

fetch('application_version.json')
  .then(response => response.json())
  .then(data => {
    const downloads = data.downloads || {};
    const macDownload = normaliseDownload(downloads.mac, 'Download for macOS');
    const windowsDownload = normaliseDownload(downloads.windows, 'Download for Windows');
    const fallbackDownload = data.download_url
      ? normaliseDownload({ url: data.download_url, label: 'Download' }, 'Download')
      : null;

    const platform = detectPlatform();
    let primary = null;

    if (platform === 'mac' && macDownload) {
      primary = macDownload;
    } else if (platform === 'windows' && windowsDownload) {
      primary = windowsDownload;
    } else {
      primary = macDownload || windowsDownload || fallbackDownload;
    }

    applyButton(primaryButton, primary, 'Download for your OS');

    const alternates = collectAlternates(primary, [macDownload, windowsDownload, fallbackDownload]);
    renderMenu(alternates);

    if (versionTag && data.version) {
      versionTag.textContent = data.version;
    }
    if (releaseMeta) {
      if (data.date) {
        const published = new Date(data.date);
        releaseMeta.textContent = `Published ${published.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' })}`;
      } else {
        releaseMeta.textContent = '';
      }
    }

    latestList.innerHTML = '';

    if (Array.isArray(data.changelog)) {
      data.changelog.forEach(line => {
        const li = document.createElement('li');
        li.textContent = line.trim();
        latestList.appendChild(li);
      });
    }
  })
  .catch(error => {
    console.error('Error loading version info:', error);
  });
  </script>
</body>
</html>
