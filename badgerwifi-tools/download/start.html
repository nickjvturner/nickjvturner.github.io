<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="color-scheme" content="light dark" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BadgerWiFi-Tools — Download</title>
  <style>
    :root { font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    body { margin: 0; display: grid; min-height: 100svh; place-items: center; padding: 24px; }
    .card { max-width: 720px; width: 100%; border: 1px solid hsl(0 0% 80% / .4);
            border-radius: 16px; padding: 24px; backdrop-filter: blur(6px); }
    h1 { margin: 0 0 .25rem; font-weight: 700; font-size: 1.5rem; }
    .muted { color: #666; margin: 0 0 1rem; }
    .grid { display: grid; gap: 12px; }
    .btn { appearance: none; border: 1px solid transparent; padding: 10px 14px; border-radius: 10px;
           font-weight: 600; cursor: pointer; text-decoration: none; display: inline-block; }
    .btn-primary { background: #2563eb; color: #fff; }
    .btn-ghost   { border-color: #ccc; color: inherit; background: transparent; }
    code, .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    details { border: 1px dashed #ccc; padding: 10px 12px; border-radius: 8px; }
    summary { cursor: pointer; font-weight: 600; }
    .os-note { padding: 10px 12px; border-left: 4px solid #2563eb; background: hsl(220 90% 60% / .07); border-radius: 6px; }
    footer { margin-top: 1rem; font-size: .9rem; color: #666; }
  </style>
</head>
<body>
  <main class="card">
    <h1>Your download is starting…</h1>
    <p class="muted">If it doesn’t begin automatically within a few seconds, use the button below.</p>

    <div class="grid" style="margin: 12px 0 16px;">
      <a id="downloadBtn" class="btn btn-primary" href="#" download>Download BadgerWiFi-Tools</a>
      <a id="alternateBtn" class="btn btn-ghost" href="#" download hidden>Switch installer</a>
      <div><small class="mono">Version: <span id="ver">–</span></small></div>
    </div>

    <p id="platformStatus" class="muted" hidden></p>

    <div class="grid">
      <div class="os-note" id="macHelp" hidden>
        <strong>macOS:</strong> Open the <span class="mono">.dmg</span>, then drag the app to <strong>Applications</strong>.<br/>
        This is a manual process for the moment...
      </div>
      <div class="os-note" id="winHelp" hidden>
        <strong>Windows:</strong> Run the installer and follow the prompts. If you see SmartScreen, choose <strong>More info</strong> → <strong>Run anyway</strong>.
      </div>
    </div>


    <footer>
      Problems? <a href="mailto:nick@badgerwifi.co.uk">Contact support</a>.
    </footer>
  </main>

  <script>
    // Get optional overrides from the URL (?file=…&v=…)
    const params = new URLSearchParams(location.search);
    const fileOverride = params.get('file');
    const versionOverride = params.get('v');

    // Populate UI
    const btn = document.getElementById('downloadBtn');
    const alternateBtn = document.getElementById('alternateBtn');
    const ver = document.getElementById('ver');
    const platformStatus = document.getElementById('platformStatus');

    // Show OS-specific notes
    const ua = navigator.userAgent.toLowerCase();
    const isMac = ua.includes('mac os x') || ua.includes('macintosh');
    const isWin = ua.includes('windows');
    document.getElementById('macHelp').hidden = !isMac;
    document.getElementById('winHelp').hidden = !isWin;
    const detectedPlatform = isMac ? 'mac' : isWin ? 'windows' : 'unknown';

    let autoTriggered = false;

    const isSafeDownload = url => {
      try {
        const parsed = new URL(url, location.origin);
        return parsed.protocol === 'https:' || parsed.protocol === 'http:';
      } catch {
        return false;
      }
    };

    const normaliseDownload = (entry, fallbackLabel) => {
      if (!entry) return null;
      if (typeof entry === 'string') {
        return { url: entry, label: fallbackLabel };
      }
      if (entry.url) {
        return { url: entry.url, label: entry.label || fallbackLabel };
      }
      return null;
    };

    const setPrimaryDownload = (download, version, { auto = false } = {}) => {
      if (version) {
        ver.textContent = version;
      }

      if (!download || !isSafeDownload(download.url)) {
        btn.href = '#';
        btn.removeAttribute('download');
        btn.textContent = 'Download unavailable';
        return;
      }

      btn.href = download.url;
      btn.setAttribute('download', '');
      btn.textContent = version ? `${download.label} (${version})` : download.label;

      if (auto && !autoTriggered) {
        autoTriggered = true;
        setTimeout(() => btn.click(), 700);
      }
    };

    const setAlternateDownload = (download, version, primaryUrl) => {
      if (!download || !isSafeDownload(download.url) || download.url === primaryUrl) {
        alternateBtn.hidden = true;
        alternateBtn.removeAttribute('href');
        alternateBtn.removeAttribute('download');
        return;
      }

      alternateBtn.hidden = false;
      alternateBtn.href = download.url;
      alternateBtn.setAttribute('download', '');
      alternateBtn.textContent = version ? `${download.label} (${version})` : download.label;
    };

    const updatePlatformMessage = text => {
      if (text) {
        platformStatus.hidden = false;
        platformStatus.textContent = text;
      } else {
        platformStatus.hidden = true;
        platformStatus.textContent = '';
      }
    };

    const overrideDownload = fileOverride && isSafeDownload(fileOverride)
      ? { url: fileOverride, label: 'Download BadgerWiFi-Tools' }
      : null;

    // Apply immediate overrides before fetching metadata
    if (overrideDownload) {
      setPrimaryDownload(overrideDownload, versionOverride || 'latest', { auto: true });
      updatePlatformMessage('Starting download from the link you requested.');
    } else if (versionOverride) {
      ver.textContent = versionOverride;
    }

    // Load the latest metadata to mirror index.html behaviour
    fetch('../application_version.json')
      .then(response => response.json())
      .then(data => {
        const downloads = data.downloads || {};
        const macDownload = normaliseDownload(downloads.mac, 'Download for macOS (.dmg)');
        const windowsDownload = normaliseDownload(downloads.windows, 'Download for Windows (.msi)');
        const fallbackDownload = data.download_url
          ? normaliseDownload({ url: data.download_url, label: 'Download latest' }, 'Download latest')
          : null;
        const version = versionOverride || data.version || 'latest';

        let primary = null;
        let alternate = null;
        let message = '';

        if (overrideDownload) {
          primary = overrideDownload;
          alternate = detectedPlatform === 'mac' ? windowsDownload : macDownload;
          message = alternate && alternate.url !== primary.url
            ? 'Direct download requested. Use the alternate installer if you need a different OS.'
            : 'Direct download requested.';
        } else if (detectedPlatform === 'mac' && macDownload) {
          primary = macDownload;
          alternate = windowsDownload;
          message = windowsDownload
            ? 'Detected macOS. If you need Windows instead, grab the alternate installer.'
            : 'Detected macOS.';
        } else if (detectedPlatform === 'windows' && windowsDownload) {
          primary = windowsDownload;
          alternate = macDownload;
          message = macDownload
            ? 'Detected Windows. If you need macOS instead, grab the alternate installer.'
            : 'Detected Windows.';
        } else {
          primary = macDownload || windowsDownload || fallbackDownload;
          alternate = primary === macDownload ? windowsDownload : macDownload;
          if (macDownload && windowsDownload) {
            message = 'We couldn’t detect your OS. Choose the installer that matches your system.';
          } else if (primary) {
            message = 'Download the installer that matches your system.';
          }
        }

        setPrimaryDownload(primary, version, { auto: !overrideDownload });
        setAlternateDownload(alternate, version, primary && primary.url);
        updatePlatformMessage(message);
      })
      .catch(err => {
        console.error('Failed to load application_version.json', err);
      });
  </script>
</body>
</html>
