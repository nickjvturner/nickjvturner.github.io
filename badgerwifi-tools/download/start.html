<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="color-scheme" content="light dark" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BadgerWiFi-Tools — Download</title>
  <style>
    :root { font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    body { margin: 0; display: grid; min-height: 100svh; place-items: center; padding: 24px; }
    .card { max-width: 720px; width: 100%; border: 1px solid hsl(0 0% 80% / .4);
            border-radius: 16px; padding: 24px; backdrop-filter: blur(6px); }
    h1 { margin: 0 0 .25rem; font-weight: 700; font-size: 1.5rem; }
    .muted { color: #666; margin: 0 0 1rem; }
    .grid { display: grid; gap: 12px; }
    .btn { appearance: none; border: 1px solid transparent; padding: 10px 14px; border-radius: 10px;
           font-weight: 600; cursor: pointer; text-decoration: none; display: inline-block; }
    .btn-primary { background: #2563eb; color: #fff; }
    .btn-ghost   { border-color: #ccc; color: inherit; background: transparent; }
    .split-control { position: relative; display: inline-flex; align-items: stretch; border-radius: 10px;
                     box-shadow: 0 10px 24px rgba(37, 99, 235, 0.25); }
    .split-control .btn { border-radius: 0; border: none; box-shadow: none; }
    .split-control .btn-primary { background: linear-gradient(135deg, #2563eb, #1d4ed8); }
    .split-control .split-toggle { width: 3rem; padding: 0; display: grid; place-items: center;
                                   border-left: 1px solid rgba(255,255,255,0.35); border-radius: 0 10px 10px 0; }
    .split-control .split-toggle:hover { filter: brightness(0.92); }
    .split-control .split-toggle:focus-visible { outline: 2px solid rgba(37,99,235,0.8); outline-offset: 2px; }
    .dropdown-menu { position: absolute; top: calc(100% + 0.5rem); right: 0; min-width: 240px; background: #fff;
                     border: 1px solid rgba(0,0,0,0.1); border-radius: 10px; box-shadow: 0 12px 24px rgba(0,0,0,0.15);
                     padding: 0.4rem 0; z-index: 30; }
    .dropdown-menu a { display: block; padding: 0.65rem 1rem; text-decoration: none; color: #1f2937; font-size: 0.95rem; }
    .dropdown-menu a:hover { background: #f3f4f6; }
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden;
               clip: rect(0, 0, 0, 0); border: 0; }
    code, .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    details { border: 1px dashed #ccc; padding: 10px 12px; border-radius: 8px; }
    summary { cursor: pointer; font-weight: 600; }
    .os-note { padding: 10px 12px; border-left: 4px solid #2563eb; background: hsl(220 90% 60% / .07); border-radius: 6px; }
    footer { margin-top: 1rem; font-size: .9rem; color: #666; }
  </style>
</head>
<body>
  <main class="card">
    <h1>Your download is starting…</h1>
    <p class="muted">If it doesn’t begin automatically within a few seconds, use the button below.</p>

    <div class="grid" style="margin: 12px 0 16px;">
      <div class="split-control" id="downloadControls">
        <a id="downloadBtn" class="btn btn-primary" href="#" download>Download BadgerWiFi-Tools</a>
        <button id="downloadMenuToggle" class="btn btn-primary split-toggle" type="button" aria-haspopup="menu" aria-expanded="false" hidden>
          <span aria-hidden="true">▾</span>
          <span class="sr-only">Show other installers</span>
        </button>
        <div id="downloadMenu" class="dropdown-menu" role="menu" hidden></div>
      </div>
      <div><small class="mono">Version: <span id="ver">–</span></small></div>
    </div>

    <div class="grid">
      <div class="os-note" id="macHelp" hidden>
        <strong>macOS:</strong> Open the <span class="mono">.dmg</span>, then drag the app to <strong>Applications</strong>.<br/>
        This is a manual process for the moment...
      </div>
      <div class="os-note" id="winHelp" hidden>
        <strong>Windows:</strong> Run the installer and follow the prompts. If you see SmartScreen, choose <strong>More info</strong> → <strong>Run anyway</strong>.
      </div>
    </div>


    <footer>
      Problems? <a href="mailto:nick@badgerwifi.co.uk">Contact support</a>.
    </footer>
  </main>

  <script>
    // Get optional overrides from the URL (?file=…&v=…)
    const params = new URLSearchParams(location.search);
    const fileOverride = params.get('file');
    const versionOverride = params.get('v');

    // Populate UI
    const btn = document.getElementById('downloadBtn');
    const menuToggle = document.getElementById('downloadMenuToggle');
    const menu = document.getElementById('downloadMenu');
    const controls = document.getElementById('downloadControls');
    const ver = document.getElementById('ver');
    btn.style.borderTopRightRadius = '10px';
    btn.style.borderBottomRightRadius = '10px';
    menuToggle.style.borderTopRightRadius = '10px';
    menuToggle.style.borderBottomRightRadius = '10px';

    // Show OS-specific notes
    const ua = navigator.userAgent.toLowerCase();
    const isMac = ua.includes('mac os x') || ua.includes('macintosh');
    const isWin = ua.includes('windows');
    document.getElementById('macHelp').hidden = !isMac;
    document.getElementById('winHelp').hidden = !isWin;
    const detectedPlatform = isMac ? 'mac' : isWin ? 'windows' : 'unknown';

    let autoTriggered = false;

    const isSafeDownload = url => {
      try {
        const parsed = new URL(url, location.origin);
        return parsed.protocol === 'https:' || parsed.protocol === 'http:';
      } catch {
        return false;
      }
    };

    const normaliseDownload = (entry, fallbackLabel) => {
      if (!entry) return null;
      if (typeof entry === 'string') {
        return { url: entry, label: fallbackLabel };
      }
      if (entry.url) {
        return { url: entry.url, label: entry.label || fallbackLabel };
      }
      return null;
    };

    const collectAlternates = (primary, candidates) => {
      const options = [];
      const seen = new Set();
      const primaryUrl = primary && primary.url;
      candidates.forEach(candidate => {
        if (!candidate || !candidate.url) return;
        if (candidate.url === primaryUrl) return;
        if (seen.has(candidate.url)) return;
        seen.add(candidate.url);
        options.push(candidate);
      });
      return options;
    };

    const closeMenu = () => {
      if (menu.hidden) return;
      menu.hidden = true;
      menuToggle.setAttribute('aria-expanded', 'false');
    };

    const renderMenu = (items, version) => {
      menu.innerHTML = '';

      if (!items.length) {
        closeMenu();
        menuToggle.hidden = true;
        menuToggle.setAttribute('aria-expanded', 'false');
        btn.style.borderTopRightRadius = '10px';
        btn.style.borderBottomRightRadius = '10px';
        menuToggle.style.borderTopRightRadius = '10px';
        menuToggle.style.borderBottomRightRadius = '10px';
        return;
      }

      items.forEach(item => {
        const link = document.createElement('a');
        link.href = item.url;
        link.setAttribute('download', '');
        link.setAttribute('role', 'menuitem');
        link.textContent = version ? `${item.label} (${version})` : item.label;
        link.addEventListener('click', () => closeMenu());
        menu.appendChild(link);
      });

      menu.hidden = true;
      menuToggle.hidden = false;
      menuToggle.setAttribute('aria-expanded', 'false');
      btn.style.borderTopRightRadius = '0';
      btn.style.borderBottomRightRadius = '0';
      menuToggle.style.borderTopRightRadius = '10px';
      menuToggle.style.borderBottomRightRadius = '10px';
    };

    menuToggle.addEventListener('click', event => {
      event.stopPropagation();
      if (menu.hidden) {
        menu.hidden = false;
        menuToggle.setAttribute('aria-expanded', 'true');
      } else {
        closeMenu();
      }
    });

    document.addEventListener('click', event => {
      if (menuToggle.hidden) return;
      if (!controls.contains(event.target)) {
        closeMenu();
      }
    });

    document.addEventListener('keydown', event => {
      if (event.key === 'Escape') {
        closeMenu();
      }
    });

    btn.addEventListener('click', () => closeMenu());

    const setPrimaryDownload = (download, version, { auto = false } = {}) => {
      if (version) {
        ver.textContent = version;
      }

      if (!download || !isSafeDownload(download.url)) {
        btn.href = '#';
        btn.removeAttribute('download');
        btn.textContent = 'Download unavailable';
        closeMenu();
        return;
      }

      btn.href = download.url;
      btn.setAttribute('download', '');
      btn.textContent = version ? `${download.label} (${version})` : download.label;

      if (auto && !autoTriggered) {
        autoTriggered = true;
        setTimeout(() => btn.click(), 700);
      }
    };

    const overrideDownload = fileOverride && isSafeDownload(fileOverride)
      ? { url: fileOverride, label: 'Download BadgerWiFi-Tools' }
      : null;

    // Apply immediate overrides before fetching metadata
    if (overrideDownload) {
      setPrimaryDownload(overrideDownload, versionOverride || 'latest', { auto: true });
    } else if (versionOverride) {
      ver.textContent = versionOverride;
    }

    // Load the latest metadata to mirror index.html behaviour
    fetch('../application_version.json')
      .then(response => response.json())
      .then(data => {
        const downloads = data.downloads || {};
        const macDownload = normaliseDownload(downloads.mac, 'Download for macOS (.dmg)');
        const windowsDownload = normaliseDownload(downloads.windows, 'Download for Windows (.msi)');
        const fallbackDownload = data.download_url
          ? normaliseDownload({ url: data.download_url, label: 'Download latest' }, 'Download latest')
          : null;
        const version = versionOverride || data.version || 'latest';

        let primary = null;

        if (overrideDownload) {
          primary = overrideDownload;
        } else if (detectedPlatform === 'mac' && macDownload) {
          primary = macDownload;
        } else if (detectedPlatform === 'windows' && windowsDownload) {
          primary = windowsDownload;
        } else {
          primary = macDownload || windowsDownload || fallbackDownload;
        }

        setPrimaryDownload(primary, version, { auto: !overrideDownload });

        const alternates = collectAlternates(primary, [macDownload, windowsDownload, fallbackDownload]);
        renderMenu(alternates, version);

      })
      .catch(err => {
        console.error('Failed to load application_version.json', err);
      });
  </script>
</body>
</html>
