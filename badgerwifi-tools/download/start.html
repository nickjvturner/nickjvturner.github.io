<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <title>BadgerWiFi-Tools — Download</title>
  <style>
    :root {
      color-scheme: light dark;
      font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      --bg: #edf1f5;
      --card-bg: rgba(255, 255, 255, 0.9);
      --card-border: hsla(215, 25%, 65%, 0.45);
      --text: #0f172a;
      --muted: #4b5563;
      --divider: hsla(215, 25%, 65%, 0.45);
      --btn-start: #2563eb;
      --btn-end: #1d4ed8;
      --btn-border: rgba(255, 255, 255, 0.35);
      --menu-bg: rgba(255, 255, 255, 0.98);
      --menu-hover: rgba(37, 99, 235, 0.12);
      --shadow: 0 16px 36px rgba(15, 23, 42, 0.16);
      --note-bg: rgba(37, 99, 235, 0.08);
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #050b18;
        --card-bg: rgba(15, 23, 42, 0.92);
        --card-border: hsla(220, 45%, 28%, 0.58);
        --text: #e2e8f0;
        --muted: #94a3b8;
        --divider: hsla(220, 45%, 28%, 0.42);
        --btn-start: #3b82f6;
        --btn-end: #2563eb;
        --btn-border: rgba(148, 163, 184, 0.42);
        --menu-bg: rgba(15, 23, 42, 0.96);
        --menu-hover: hsla(220, 90%, 70%, 0.18);
        --shadow: 0 20px 48px rgba(2, 6, 23, 0.55);
        --note-bg: rgba(37, 99, 235, 0.16);
      }
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100svh;
      display: grid;
      place-items: center;
      padding: 24px;
      background: var(--bg);
      color: var(--text);
      transition: background 0.3s ease;
    }

    a {
      color: inherit;
    }

    main.card {
      width: min(720px, 100%);
      border-radius: 20px;
      border: 1px solid var(--card-border);
      background: var(--card-bg);
      padding: 32px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      display: grid;
      gap: 24px;
    }

    h1 {
      margin: 0;
      font-size: 1.55rem;
      font-weight: 700;
    }

    .muted {
      margin: 0;
      color: var(--muted);
    }

    .btn {
      appearance: none;
      border: 1px solid transparent;
      padding: 12px 20px;
      border-radius: 12px;
      font-family: inherit;
      font-size: 1rem;
      font-weight: 600;
      letter-spacing: -0.01em;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: filter 0.2s ease, background 0.2s ease;
    }

    .split-control {
      position: relative;
      display: inline-flex;
      align-items: stretch;
      border-radius: 12px;
      filter: drop-shadow(0 12px 28px rgba(37, 99, 235, 0.18));
    }

    .split-control .btn {
      border-radius: 0;
      border: none;
    }

    #downloadBtn {
      border-radius: 12px 0 0 12px;
      min-width: 240px;
      background: linear-gradient(135deg, var(--btn-start), var(--btn-end));
      color: #fff;
    }

    #downloadBtn:hover {
      filter: brightness(1.06);
    }

    #downloadBtn:focus-visible {
      outline: 2px solid rgba(59, 130, 246, 0.5);
      outline-offset: 2px;
    }

    .split-control .split-toggle {
      width: 3rem;
      display: grid;
      place-items: center;
      background: linear-gradient(135deg, var(--btn-end), var(--btn-start));
      border-left: 1px solid var(--btn-border);
      border-radius: 0 12px 12px 0;
      color: #fff;
      cursor: pointer;
      font-size: 1.1rem;
    }

    .split-control .split-toggle:hover {
      filter: brightness(1.06);
    }

    .split-control .split-toggle:focus-visible {
      outline: 2px solid rgba(59, 130, 246, 0.6);
      outline-offset: 3px;
    }

    .dropdown-menu {
      position: absolute;
      top: calc(100% + 0.5rem);
      right: 0;
      min-width: 240px;
      background: var(--menu-bg);
      border: 1px solid var(--divider);
      border-radius: 12px;
      box-shadow: var(--shadow);
      padding: 0.35rem 0;
      z-index: 30;
      backdrop-filter: blur(16px);
    }

    .dropdown-menu a {
      display: block;
      padding: 0.65rem 1rem;
      color: var(--text);
      text-decoration: none;
      font-weight: 500;
    }

    .dropdown-menu a:hover {
      background: var(--menu-hover);
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      border: 0;
    }

    .grid {
      display: grid;
      gap: 12px;
    }
    .supporting {
      display: grid;
      gap: 6px;
    }

    .meta-row {
      font-size: 0.95rem;
      color: var(--muted);
    }

    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    }

    .notes {
      display: grid;
      gap: 12px;
    }

    .os-note {
      padding: 12px 14px;
      border-left: 4px solid var(--btn-start);
      border-radius: 10px;
      background: var(--note-bg);
      color: var(--text);
    }

    footer {
      margin-top: 4px;
      font-size: 0.95rem;
      color: var(--muted);
    }
  </style>
</head>
<body>
  <main class="card">
    <div class="supporting">
      <h1>Your download is starting…</h1>
      <p class="muted">If it doesn’t begin automatically, launch it with the button below.</p>
    </div>

    <div class="grid" style="margin: 12px 0 16px;">
      <div class="split-control" id="downloadControls">
        <a id="downloadBtn" class="btn btn-primary" href="#" download>Download BadgerWiFi-Tools</a>
        <button id="downloadMenuToggle" class="btn split-toggle" type="button" aria-haspopup="menu" aria-expanded="false" hidden>
          <span aria-hidden="true">▾</span>
          <span class="sr-only">Show other installers</span>
        </button>
        <div id="downloadMenu" class="dropdown-menu" role="menu" hidden></div>
      </div>
      <div class="meta-row mono">Version: <span id="ver">–</span></div>
    </div>

    <section class="notes">
      <div class="os-note" id="macHelp" hidden>
        <strong>macOS:</strong> Open the <span class="mono">.dmg</span>, then drag the app to <strong>Applications</strong>.
      </div>
      <div class="os-note" id="winHelp" hidden>
        <strong>Windows:</strong> Run the installer and follow the prompts. If SmartScreen appears, choose <strong>More info</strong> → <strong>Run anyway</strong>.
      </div>
    </section>

    <footer>
      Problems? <a href="mailto:nick@badgerwifi.co.uk">Contact support</a>.
    </footer>
  </main>

  <script>
    const params = new URLSearchParams(location.search);
    const fileOverride = params.get('file');
    const versionOverride = params.get('v');

    const btn = document.getElementById('downloadBtn');
    const menuToggle = document.getElementById('downloadMenuToggle');
    const menu = document.getElementById('downloadMenu');
    const controls = document.getElementById('downloadControls');
    const ver = document.getElementById('ver');

    const defaultRadius = '12px';
    btn.style.borderTopRightRadius = defaultRadius;
    btn.style.borderBottomRightRadius = defaultRadius;
    menuToggle.style.borderTopRightRadius = defaultRadius;
    menuToggle.style.borderBottomRightRadius = defaultRadius;

    const ua = navigator.userAgent.toLowerCase();
    const isMac = ua.includes('mac os x') || ua.includes('macintosh');
    const isWin = ua.includes('windows');
    document.getElementById('macHelp').hidden = !isMac;
    document.getElementById('winHelp').hidden = !isWin;
    const detectedPlatform = isMac ? 'mac' : isWin ? 'windows' : 'unknown';

    let autoTriggered = false;

    const isSafeDownload = url => {
      try {
        const parsed = new URL(url, location.origin);
        return parsed.protocol === 'https:' || parsed.protocol === 'http:';
      } catch {
        return false;
      }
    };

    const normaliseDownload = (entry, fallbackLabel) => {
      if (!entry) return null;
      if (typeof entry === 'string') {
        return { url: entry, label: fallbackLabel };
      }
      if (entry.url) {
        return { url: entry.url, label: entry.label || fallbackLabel };
      }
      return null;
    };

    const collectAlternates = (primary, candidates) => {
      const options = [];
      const seen = new Set();
      const primaryUrl = primary && primary.url;
      candidates.forEach(candidate => {
        if (!candidate || !candidate.url) return;
        if (candidate.url === primaryUrl) return;
        if (seen.has(candidate.url)) return;
        seen.add(candidate.url);
        options.push(candidate);
      });
      return options;
    };

    const closeMenu = () => {
      if (menu.hidden) return;
      menu.hidden = true;
      menuToggle.setAttribute('aria-expanded', 'false');
    };

    const renderMenu = (items, version) => {
      menu.innerHTML = '';

      if (!items.length) {
        closeMenu();
        menuToggle.hidden = true;
        menuToggle.setAttribute('aria-expanded', 'false');
        btn.style.borderTopRightRadius = defaultRadius;
        btn.style.borderBottomRightRadius = defaultRadius;
        menuToggle.style.borderTopRightRadius = defaultRadius;
        menuToggle.style.borderBottomRightRadius = defaultRadius;
        return;
      }

      items.forEach(item => {
        const link = document.createElement('a');
        link.href = item.url;
        link.setAttribute('download', '');
        link.setAttribute('role', 'menuitem');
        link.textContent = version ? `${item.label} (${version})` : item.label;
        link.addEventListener('click', () => closeMenu());
        menu.appendChild(link);
      });

      menu.hidden = true;
      menuToggle.hidden = false;
      menuToggle.setAttribute('aria-expanded', 'false');
      btn.style.borderTopRightRadius = '0';
      btn.style.borderBottomRightRadius = '0';
      menuToggle.style.borderTopRightRadius = defaultRadius;
      menuToggle.style.borderBottomRightRadius = defaultRadius;
    };

    menuToggle.addEventListener('click', event => {
      event.stopPropagation();
      if (menu.hidden) {
        menu.hidden = false;
        menuToggle.setAttribute('aria-expanded', 'true');
      } else {
        closeMenu();
      }
    });

    document.addEventListener('click', event => {
      if (menuToggle.hidden) return;
      if (!controls.contains(event.target)) {
        closeMenu();
      }
    });

    document.addEventListener('keydown', event => {
      if (event.key === 'Escape') {
        closeMenu();
      }
    });

    btn.addEventListener('click', () => closeMenu());

    const setPrimaryDownload = (download, version, { auto = false } = {}) => {
      if (version) {
        ver.textContent = version;
      }

      if (!download || !isSafeDownload(download.url)) {
        btn.href = '#';
        btn.removeAttribute('download');
        btn.textContent = 'Download unavailable';
        closeMenu();
        return;
      }

      btn.href = download.url;
      btn.setAttribute('download', '');
      btn.textContent = version ? `${download.label} (${version})` : download.label;

      if (auto && !autoTriggered) {
        autoTriggered = true;
        setTimeout(() => btn.click(), 700);
      }
    };

    const overrideDownload = fileOverride && isSafeDownload(fileOverride)
      ? { url: fileOverride, label: 'Download BadgerWiFi-Tools' }
      : null;

    if (overrideDownload) {
      setPrimaryDownload(overrideDownload, versionOverride || 'latest', { auto: true });
    } else if (versionOverride) {
      ver.textContent = versionOverride;
    }

    fetch('../application_version.json')
      .then(response => response.json())
      .then(data => {
        const downloads = data.downloads || {};
        const macDownload = normaliseDownload(downloads.mac, 'Download for macOS (.dmg)');
        const windowsDownload = normaliseDownload(downloads.windows, 'Download for Windows (.msi)');
        const fallbackDownload = data.download_url
          ? normaliseDownload({ url: data.download_url, label: 'Download latest' }, 'Download latest')
          : null;
        const version = versionOverride || data.version || 'latest';

        let primary = null;

        if (overrideDownload) {
          primary = overrideDownload;
        } else if (detectedPlatform === 'mac' && macDownload) {
          primary = macDownload;
        } else if (detectedPlatform === 'windows' && windowsDownload) {
          primary = windowsDownload;
        } else {
          primary = macDownload || windowsDownload || fallbackDownload;
        }

        setPrimaryDownload(primary, version, { auto: !overrideDownload });

        const alternates = collectAlternates(primary, [macDownload, windowsDownload, fallbackDownload]);
        renderMenu(alternates, version);
      })
      .catch(err => {
        console.error('Failed to load application_version.json', err);
      });
  </script>
</body>
</html>
